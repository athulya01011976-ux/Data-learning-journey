CREATE 	DATABASE sales_database;
USE sales_database;

-- Customers table
CREATE TABLE customers (
    customer_id INT PRIMARY KEY,
    customer_name VARCHAR(50),
    region VARCHAR(20));

-- Products table
CREATE TABLE products (
    product_id INT PRIMARY KEY,
    product_name VARCHAR(50),
    category VARCHAR(30),
    price DECIMAL(10,2));

-- Orders table
CREATE TABLE orders (
    order_id INT PRIMARY KEY,
    customer_id INT,
    product_id INT,
    quantity INT,
    order_date DATE,
    FOREIGN KEY (customer_id) REFERENCES customers(customer_id),
    FOREIGN KEY (product_id) REFERENCES products(product_id));

INSERT INTO customers (customer_id, customer_name, region) VALUES
(1, 'Alice', 'North'),
(2, 'Bob', 'South'),
(3, 'Charlie', 'North'),
(4, 'Diana', 'East'),
(5, 'Evan', 'West');

INSERT INTO products (product_id, product_name, category, price) VALUES
(101, 'Laptop', 'Electronics', 1000),
(102, 'Phone', 'Electronics', 700),
(103, 'Chair', 'Furniture', 150),
(104, 'Desk', 'Furniture', 300),
(105, 'Headphones', 'Electronics', 200);

INSERT INTO orders (order_id, customer_id, product_id, quantity, order_date) VALUES
(1001, 1, 101, 1, '2024-01-05'),
(1002, 1, 102, 2, '2024-01-10'),
(1003, 2, 103, 4, '2024-01-15'),
(1004, 3, 104, 1, '2024-02-01'),
(1005, 3, 101, 1, '2024-02-05'),
(1006, 4, 105, 3, '2024-02-10'),
(1007, 5, 103, 2, '2024-02-15');

-- List all customers from the North region
SELECT customer_name FROM customers
WHERE region = "North";

-- Show all products that cost more than 500
SELECT product_name , price FROM products
WHERE price > 500;

-- Count total number of orders
SELECT COUNT(order_id) AS total_orders
FROM orders;

-- Display distinct product categories
SELECT DISTINCT(category) FROM products;

-- List orders placed after 2024-02-01
SELECT order_id , order_date 
FROM orders
WHERE order_date > "2024-02-01";

-- Show customer name and product name for each order
SELECT c.customer_name, p.product_name
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
JOIN products p ON o.product_id = p.product_id;

-- Calculate total revenue per order
SELECT o.order_id , (o.quantity*p.price) AS revenue
FROM orders o
JOIN products p ON o.product_id = p.product_id
ORDER BY revenue DESC;

-- Find total revenue generated by each customer
SELECT c.customer_name ,SUM(o.quantity * p.price) AS total_revenue 
FROM customers c
JOIN orders o ON o.customer_id = c.customer_id
JOIN products p ON o.product_id = p.product_id
GROUP BY c.customer_name ,c.customer_id
ORDER BY total_revenue DESC;

-- Find customers who have placed more than one order
SELECT c.customer_name 
FROM customers c 
JOIN orders o ON c.customer_id = o.customer_id 
GROUP BY c.customer_id
HAVING COUNT(o.order_id)>1;

-- Find average order revenue
SELECT AVG(o.quantity*p.price) AS avg_revenue
FROM orders o
JOIN products p ON o.product_id = p.product_id;

-- Show revenue by product category
SELECT p.category , SUM(o.quantity*p.price) AS revenue
FROM orders o
JOIN products p ON o.product_id = p.product_id
GROUP BY p.category
ORDER BY revenue DESC;

-- List customers who never ordered Electronics products
SELECT c.customer_name
FROM customers c
WHERE NOT EXISTS (
    SELECT 1 FROM orders o
    JOIN products p ON o.product_id = p.product_id
    WHERE o.customer_id = c.customer_id
	AND p.category = 'Electronics');


-- Show month-wise total revenue
SELECT DATE_FORMAT(order_date, '%Y-%m') AS Month,
SUM(o.quantity*p.price) AS revenue
FROM orders o
JOIN products p ON o.product_id = p.product_id
GROUP BY Month;

-- Find the highest revenue order
SELECT o.order_id , SUM(o.quantity*p.price) AS revenue
FROM orders o
JOIN products p ON o.product_id = p.product_id
GROUP BY order_id
ORDER BY revenue DESC
LIMIT 1;

-- Rank customers by total revenue
WITH CustomerRevenue AS (
    SELECT c.customer_name, SUM(o.quantity * p.price) AS total_revenue
    FROM customers c  
    JOIN orders o ON o.customer_id = c.customer_id
    JOIN products p ON o.product_id = p.product_id
    GROUP BY c.customer_name)
SELECT customer_name, total_revenue,
RANK() OVER(ORDER BY total_revenue DESC) AS rn
FROM CustomerRevenue
ORDER BY rn;
